<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Workout Tick Tracker ‚Äî ‡∏Ç‡∏≠‡∏á‡∏£‡∏¥‡∏ß (‡∏°‡∏µ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô)</title>
  <style>
    :root{--bg:#0b0f14;--panel:#121822;--muted:#8892a6;--accent:#5eead4;--good:#22c55e;--bad:#ef4444;--text:#e5e7eb}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:linear-gradient(180deg,#0b0f14,#0e141d 35%,#0b0f14); color:var(--text)}
    .wrap{max-width:980px;margin:auto;padding:18px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    h1{font-size:clamp(20px,4.5vw,34px);margin:0;font-weight:800;letter-spacing:.3px}
    .card{background:rgba(18,24,34,.9);border:1px solid #1f2937;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    button,.chip{border:1px solid #243041;background:#151d29;color:var(--text);padding:10px 12px;border-radius:12px;font-weight:600;cursor:pointer}
    button:hover{filter:brightness(1.05)}
    button.primary{background:linear-gradient(90deg,#14b8a6,#22d3ee);border-color:transparent;color:#021218}
    button.good{background:#12321c;border-color:#1f7a3b;color:#bff7c9}
    button.bad{background:#321212;border-color:#7a1f1f;color:#ffc9c9}
    .muted{color:var(--muted)}
    .grid{display:grid;gap:14px}
    @media(min-width:860px){ .grid{grid-template-columns:1.3fr .9fr} }
    /* Calendar */
    .cal{padding:14px}
    .cal header{justify-content:space-between}
    .cal .week{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:10px}
    .cal .cell{aspect-ratio:1/1;display:flex;flex-direction:column;justify-content:center;align-items:center;border-radius:14px;border:1px dashed #253044;background:#0f1520;position:relative}
    .cal .cell .d{font-weight:700;opacity:.9}
    .cal .cell .mark{font-size:18px;margin-top:6px}
    .cal .cell.done{border:1px solid rgba(34,197,94,.4);background:linear-gradient(180deg,#0f1b15,#0f2216)}
    .cal .cell.miss{border:1px solid rgba(239,68,68,.35);background:linear-gradient(180deg,#1a0f10,#240f10)}
    .cal .cell.today{outline:2px solid #60a5fa}
    .legend{display:flex;gap:10px;align-items:center;margin-top:8px}
    .dot{width:10px;height:10px;border-radius:20px;display:inline-block}
    .dot.good{background:var(--good)}
    .dot.bad{background:var(--bad)}
    .dot.none{background:#334155}
    /* Exercises */
    .ex{padding:14px}
    .row{display:flex;align-items:center;gap:10px;padding:10px;border:1px solid #253044;border-radius:12px;background:#0f1520}
    .row input[type="text"]{flex:1;min-width:60px;background:#0b111b;border:1px solid #1f2937;border-radius:10px;color:var(--text);padding:10px}
    .row .qty{width:80px;text-align:center}
    .rows{display:flex;flex-direction:column;gap:10px}
    .inline{display:flex;gap:8px;flex-wrap:wrap}
    .stat{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;margin-top:12px}
    .stat .box{padding:12px;border:1px solid #1f2937;border-radius:12px;text-align:center;background:#0d1723}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:12px;background:#111827;border:1px solid #374151;border-radius:6px;padding:2px 6px}
    footer{margin-top:24px;font-size:13px;color:#93a2b7}
    a{color:#67e8f9;text-decoration:none}
    /* ==== Auth Overlay ==== */
    .auth{position:fixed;inset:0;background:linear-gradient(180deg,#0b0f14cc,#0e141de0);display:flex;align-items:center;justify-content:center;z-index:50}
    .auth.hide{display:none}
    .panel{width:min(520px,92vw);background:#0f1520;border:1px solid #263347;border-radius:18px;box-shadow:0 20px 50px rgba(0,0,0,.5);padding:20px}
    .panel h2{margin:0 0 4px 0}
    .panel p{margin:2px 0 14px 0;color:#9aa7bd}
    .pair{display:grid;grid-template-columns:120px 1fr;gap:8px;align-items:center;margin:8px 0}
    .pair input{width:100%;padding:10px;border-radius:10px;border:1px solid #223047;background:#0b111b;color:var(--text)}
    .note{font-size:12px;color:#9aa7bd;margin-top:10px}
  </style>
</head>
<body>
  <div class="auth" id="auth">
    <div class="panel">
      <h2 id="authTitle">üîí ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å</h2>
      <p id="authDesc">‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™ PIN ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏Å‡∏õ‡πâ‡∏≠‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏£‡∏¥‡∏ß‡∏ö‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ</p>
      <div id="setupForm">
        <div class="pair"><label>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label><input id="setupUser" placeholder="‡πÄ‡∏ä‡πà‡∏ô ryu" /></div>
        <div class="pair"><label>PIN</label><input id="setupPin" type="password" inputmode="numeric" maxlength="6" placeholder="4‚Äì6 ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç" /></div>
        <div class="pair"><label>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô PIN</label><input id="setupPin2" type="password" inputmode="numeric" maxlength="6" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ã‡πâ‡∏≥" /></div>
        <div class="inline" style="margin-top:8px">
          <button class="primary" id="btnSetup">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</button>
        </div>
        <div class="note">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏Ñ‡πà‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ (LocalStorage)</div>
      </div>
      <div id="loginForm" style="display:none">
        <div class="pair"><label>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label><input id="loginUser" placeholder="‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ" /></div>
        <div class="pair"><label>PIN</label><input id="loginPin" type="password" inputmode="numeric" maxlength="6" placeholder="PIN" /></div>
        <div class="inline" style="margin-top:8px">
          <button class="primary" id="btnLogin">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</button>
          <button id="btnForgot">‡∏•‡∏∑‡∏° PIN</button>
        </div>
        <div class="note">‡∏ñ‡πâ‡∏≤‡∏•‡∏∑‡∏° PIN ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏≠‡∏õ (‡∏à‡∏∞‡∏•‡∏ö‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥) ‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏° "‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"</div>
      </div>
    </div>
  </div>

  <div class="wrap" id="app">
    <header>
      <h1>üìÖ Workout Tick Tracker ‚Äî ‡∏Ç‡∏≠‡∏á‡∏£‡∏¥‡∏ß</h1>
      <div class="toolbar">
        <button class="primary" id="btnTodayDone" disabled>‡∏ï‡∏¥‡πä‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‚úÖ</button>
        <button class="bad" id="btnTodayMiss" disabled>‡∏Ç‡πâ‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‚ùå</button>
        <button id="btnExport" disabled>Export CSV</button>
        <button id="btnReset" disabled>‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        <button id="btnLogout" style="display:none">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
      </div>
    </header>

    <p class="muted">‡∏ó‡∏≥‡πÄ‡∏ß‡πá‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏á‡πà‡∏≤‡∏¢‡πÜ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏¥‡πä‡∏Å‡∏ß‡πà‡∏≤ <em>‡∏ã‡πâ‡∏≠‡∏°/‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≠‡∏°</em> ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡πà‡∏≤‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢ ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏£‡∏¥‡∏ß (LocalStorage) ‚Äî ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡πá‡∏ï‡∏Å‡πá‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ</p>

    <div class="grid">
      <!-- Calendar Panel -->
      <section class="card cal">
        <header>
          <div class="inline">
            <button id="prevM">‚óÄ ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô</button>
            <div class="chip" id="labelMonth"></div>
            <button id="nextM">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚ñ∂</button>
          </div>
          <div class="legend">
            <span class="dot good"></span><span class="muted">‡∏ó‡∏≥‡πÅ‡∏•‡πâ‡∏ß</span>
            <span class="dot bad" style="margin-left:10px"></span><span class="muted">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏≥</span>
            <span class="dot none" style="margin-left:10px"></span><span class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏¥‡πä‡∏Å</span>
          </div>
        </header>
        <div class="week muted" style="font-weight:700">
          <div>‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå</div><div>‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£</div><div>‡∏û‡∏∏‡∏ò</div><div>‡∏û‡∏§‡∏´‡∏±‡∏™‡∏Ø</div><div>‡∏®‡∏∏‡∏Å‡∏£‡πå</div><div>‡πÄ‡∏™‡∏≤‡∏£‡πå</div><div>‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå</div>
        </div>
        <div id="calGrid" class="week" style="margin-top:6px"></div>
      </section>

      <!-- Exercise Panel -->
      <section class="card ex">
        <h3 style="margin:4px 0 8px 2px">üèãÔ∏è ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡πà‡∏≤‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢ (‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ)</h3>
        <div class="rows" id="rows"></div>
        <div class="inline" style="margin-top:10px">
          <button id="addEx">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡πà‡∏≤</button>
          <button class="good" id="quickToday">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
        </div>
        <div class="stat">
          <div class="box"><div class="muted">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div><div id="statMonth" style="font-size:20px;font-weight:800">0 ‡∏ß‡∏±‡∏ô</div></div>
          <div class="box"><div class="muted">‡∏™‡∏ï‡∏£‡∏µ‡∏Ñ‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á</div><div id="statStreak" style="font-size:20px;font-weight:800">0 ‡∏ß‡∏±‡∏ô</div></div>
          <div class="box"><div class="muted">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><div id="statAll" style="font-size:20px;font-weight:800">0 ‡∏ß‡∏±‡∏ô</div></div>
        </div>
      </section>
    </div>

    <footer>
      ‡∏ó‡∏£‡∏¥‡∏Ñ: ‡∏Å‡∏î <span class="kbd">‡∏ï‡∏¥‡πä‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‚úÖ</span> ‡∏´‡∏•‡∏±‡∏á‡∏ã‡πâ‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à, ‡πÉ‡∏ä‡πâ <span class="kbd">Export CSV</span> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô Sheets ‡πÑ‡∏î‡πâ
    </footer>
  </div>

  <script>
    // ===== Storage Keys =====
    const KEY = 'wktt_v2';              // workout data
    const KEY_USER = 'wktt_user';       // {user, pinHash}
    const KEY_SESSION = 'wktt_session'; // "ok" when logged in

    // ===== Helpers =====
    const pad = n => String(n).padStart(2,'0');
    const fmt = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;

    function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }
    function load(){ try { return JSON.parse(localStorage.getItem(KEY)); } catch(e){ return null; } }

    async function sha256(str){
      const enc = new TextEncoder().encode(str);
      const buf = await crypto.subtle.digest('SHA-256', enc);
      return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
    }

    function setDisabled(disabled){
      ['btnTodayDone','btnTodayMiss','btnExport','btnReset','addEx','quickToday','prevM','nextM']
        .forEach(id=>{ const el=document.getElementById(id); if(el) el.disabled = !!disabled; });
      const lo = document.getElementById('btnLogout');
      if(!disabled){ lo.style.display='inline-block'; } else { lo.style.display='none'; }
    }

    function logout(){ sessionStorage.removeItem(KEY_SESSION); setDisabled(true); document.getElementById('auth').classList.remove('hide'); renderAuth(); }

    // ===== Auth UI =====
    const userBox = ()=> JSON.parse(localStorage.getItem(KEY_USER)||'null');
    function renderAuth(){
      const ub = userBox();
      const hasUser = !!ub;
      document.getElementById('authTitle').textContent = hasUser? 'üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö' : 'üîí ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å';
      document.getElementById('authDesc').textContent = hasUser? '‡πÉ‡∏™‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞ PIN ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : '‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™ PIN ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏Å‡∏õ‡πâ‡∏≠‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏£‡∏¥‡∏ß';
      document.getElementById('setupForm').style.display = hasUser? 'none' : 'block';
      document.getElementById('loginForm').style.display = hasUser? 'block' : 'none';
    }

    async function tryAutoLogin(){
      if(sessionStorage.getItem(KEY_SESSION)==='ok'){ document.getElementById('auth').classList.add('hide'); setDisabled(false); return; }
      renderAuth(); setDisabled(true); document.getElementById('auth').classList.remove('hide');
    }

    // ===== Workout State =====
    const state = load() || {
      marks: {}, // yyyy-mm-dd => 1 (done), -1 (miss)
      exercises: [
        { name: '‡∏ß‡∏¥‡∏î‡∏û‡∏∑‡πâ‡∏ô', qty: 20, unit: '‡∏Ñ‡∏£‡∏±‡πâ‡∏á' },
        { name: '‡∏™‡∏Ñ‡∏ß‡∏≠‡∏ó', qty: 30, unit: '‡∏Ñ‡∏£‡∏±‡πâ‡∏á' },
        { name: '‡πÅ‡∏û‡∏•‡∏á‡∏Å‡πå', qty: 60, unit: '‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ' },
      ],
    };

    // ===== Date =====
    const today = new Date();
    let view = new Date(today.getFullYear(), today.getMonth(), 1);

    // ===== UI Bindings =====
    const labelMonth = document.getElementById('labelMonth');
    const calGrid = document.getElementById('calGrid');
    const rows = document.getElementById('rows');

    document.getElementById('prevM').onclick = ()=>{ view.setMonth(view.getMonth()-1); renderCal(); };
    document.getElementById('nextM').onclick = ()=>{ view.setMonth(view.getMonth()+1); renderCal(); };
    document.getElementById('btnTodayDone').onclick = ()=> setMark(fmt(today), 1);
    document.getElementById('btnTodayMiss').onclick = ()=> setMark(fmt(today), -1);
    document.getElementById('btnExport').onclick = exportCSV;
    document.getElementById('btnReset').onclick = ()=>{ if(confirm('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î? (‡∏£‡∏ß‡∏° PIN)')){ localStorage.removeItem(KEY); localStorage.removeItem(KEY_USER); sessionStorage.removeItem(KEY_SESSION); location.reload(); }};
    document.getElementById('addEx').onclick = ()=>{ state.exercises.push({name:'‡∏ó‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà', qty:10, unit:'‡∏Ñ‡∏£‡∏±‡πâ‡∏á'}); save(); renderExercises(); };
    document.getElementById('quickToday').onclick = ()=>{
      const id = fmt(today);
      setMark(id, 1, false);
      const snapshot = state.exercises.map(e=>({name:e.name, qty:e.qty, unit:e.unit}));
      state.marks[id+':ex'] = snapshot;
      save(); alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß! ‚úÖ');
    };
    document.getElementById('btnLogout').onclick = logout;

    document.getElementById('btnSetup').onclick = async ()=>{
      const user = document.getElementById('setupUser').value.trim();
      const p1 = document.getElementById('setupPin').value.trim();
      const p2 = document.getElementById('setupPin2').value.trim();
      if(!user || p1.length<4 || p1!==p2){ alert('‡∏ï‡∏£‡∏ß‡∏à‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‡πÅ‡∏•‡∏∞ PIN (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 4 ‡∏´‡∏•‡∏±‡∏Å ‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô)'); return; }
      const pinHash = await sha256(user+'|'+p1);
      localStorage.setItem(KEY_USER, JSON.stringify({user, pinHash}));
      sessionStorage.setItem(KEY_SESSION,'ok');
      document.getElementById('auth').classList.add('hide'); setDisabled(false);
    };

    document.getElementById('btnLogin').onclick = async ()=>{
      const user = document.getElementById('loginUser').value.trim();
      const pin = document.getElementById('loginPin').value.trim();
      const ub = userBox(); if(!ub){ alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Å‡πà‡∏≠‡∏ô'); return; }
      const hash = await sha256(user+'|'+pin);
      if(hash===ub.pinHash){ sessionStorage.setItem(KEY_SESSION,'ok'); document.getElementById('auth').classList.add('hide'); setDisabled(false); }
      else alert('‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠ PIN ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
    };

    document.getElementById('btnForgot').onclick = ()=>{
      alert('‡∏ñ‡πâ‡∏≤‡∏•‡∏∑‡∏° PIN: ‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πà‡∏° "‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞ PIN ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏´‡∏°‡πà');
    };

    function setMark(id,val,notify=true){
      state.marks[id] = val; save(); renderCal(); updateStats();
      if(notify) alert(val===1? '‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡πà‡∏≤ "‡∏ó‡∏≥‡πÅ‡∏•‡πâ‡∏ß" ‚úÖ' : '‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡πà‡∏≤ "‡∏Ç‡πâ‡∏≤‡∏°" ‚ùå');
    }

    function renderCal(){
      const y = view.getFullYear(), m = view.getMonth();
      const monthName = new Intl.DateTimeFormat('th-TH',{month:'long',year:'numeric'}).format(view);
      labelMonth.textContent = monthName;
      calGrid.innerHTML = '';
      const first = new Date(y,m,1);
      const startOffset = (first.getDay()+6)%7; // Monday=0
      const daysInMonth = new Date(y,m+1,0).getDate();
      for(let i=0;i<startOffset;i++){ const div=document.createElement('div'); calGrid.appendChild(div); }
      for(let d=1; d<=daysInMonth; d++){
        const id = `${y}-${pad(m+1)}-${pad(d)}`;
        const cell = document.createElement('button');
        cell.className = 'cell';
        cell.innerHTML = `<div class="d">${d}</div><div class="mark">${markEmoji(state.marks[id])}</div>`;
        if(id===fmt(today)) cell.classList.add('today');
        if(state.marks[id]===1) cell.classList.add('done');
        if(state.marks[id]===-1) cell.classList.add('miss');
        cell.onclick = ()=>{
          const cur = state.marks[id]||0;
          const next = cur===1? -1 : cur===-1? 0 : 1; // cycle: none -> done -> miss -> none
          if(next===0) delete state.marks[id]; else state.marks[id]=next;
          save(); renderCal(); updateStats();
        };
        calGrid.appendChild(cell);
      }
    }
    function markEmoji(v){ return v===1?'‚úÖ': v===-1? '‚ùå':'¬∑'; }

    function renderExercises(){
      rows.innerHTML = '';
      state.exercises.forEach((ex,i)=>{
        const div = document.createElement('div');
        div.className='row';
        div.innerHTML = `
          <input type="text" value="${ex.name}" aria-label="‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡πà‡∏≤"/>
          <input class="qty" type="number" min="1" value="${ex.qty}" aria-label="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"/>
          <input class="qty" type="text" value="${ex.unit}" aria-label="‡∏´‡∏ô‡πà‡∏ß‡∏¢"/>
          <button data-act="tick">‡∏ï‡∏¥‡πä‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
          <button data-act="del" class="bad">‡∏•‡∏ö</button>
        `;
        const [name,qty,unit] = div.querySelectorAll('input');
        name.onchange = ()=>{ ex.name=name.value; save(); };
        qty.onchange = ()=>{ ex.qty=Number(qty.value||1); save(); };
        unit.onchange = ()=>{ ex.unit=unit.value; save(); };
        div.querySelector('[data-act=tick]').onclick = ()=>{
          const id = fmt(today);
          const snap = state.marks[id+':ex'] || [];
          const found = snap.find(s=>s.name===ex.name);
          if(found){ found.qty = ex.qty; found.unit = ex.unit; }
          else snap.push({name:ex.name, qty:ex.qty, unit:ex.unit});
          state.marks[id+':ex'] = snap; setMark(id, 1, false); save(); renderCal(); updateStats();
        };
        div.querySelector('[data-act=del]').onclick = ()=>{
          if(confirm('‡∏•‡∏ö‡∏ó‡πà‡∏≤‡∏ô‡∏µ‡πâ?')){ state.exercises.splice(i,1); save(); renderExercises(); }
        };
        rows.appendChild(div);
      });
    }

    function exportCSV(){
      const lines = [['date','status','exercises']];
      const keys = Object.keys(state.marks).filter(k=>!/\:ex$/.test(k)).sort();
      for(const k of keys){
        const s = state.marks[k];
        const exs = state.marks[k+':ex'] || [];
        const exTxt = exs.map(e=>`${e.name} ${e.qty} ${e.unit}`).join(' | ');
        lines.push([k, s===1?'done': s===-1?'miss':'', exTxt]);
      }
      const csv = lines.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('
');
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='workout_rio.csv'; a.click(); URL.revokeObjectURL(url);
    }

    function updateStats(){
      const y = view.getFullYear(), m=view.getMonth()+1; const ym = `${y}-${pad(m)}-`;
      const monthDone = Object.entries(state.marks).filter(([k,v])=>!k.endsWith(':ex') && k.startsWith(ym) && v===1).length;
      document.getElementById('statMonth').textContent = monthDone+ ' ‡∏ß‡∏±‡∏ô';
      const allDone = Object.entries(state.marks).filter(([k,v])=>!k.endsWith(':ex') && v===1).length;
      document.getElementById('statAll').textContent = allDone + ' ‡∏ß‡∏±‡∏ô';
      let d = new Date(); let streak=0;
      while(true){ const id=fmt(d); if(state.marks[id]===1){ streak++; d.setDate(d.getDate()-1);} else break; }
      document.getElementById('statStreak').textContent = streak + ' ‡∏ß‡∏±‡∏ô';
    }

    function init(){ renderCal(); renderExercises(); updateStats(); tryAutoLogin(); }
    init();
  </script>
</body>
</html>
