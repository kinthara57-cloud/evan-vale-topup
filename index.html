<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b0f0c">
  <link rel="icon" href="images/evanvale-logo.png?v=7" sizes="any">
  <link rel="apple-touch-icon" href="images/evanvale-logo.png?v=7">

  <title>EVAN VALE ‚Ä¢ Topup | ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Å‡∏°‡πÑ‡∏ß ‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™ ‡∏°‡∏µ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏î‡∏π‡πÅ‡∏•</title>
  <meta name="description" content="EVAN VALE ‚Äî ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Å‡∏°‡πÑ‡∏ß ‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™ ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡∏°‡∏µ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏î‡∏π‡πÅ‡∏• ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö TrueMoney, PromptPay ‡πÅ‡∏•‡∏∞‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£" />

  <style>
    :root{
      --bg:#0b0f0c;
      --panel:#0f1612;
      --card:#101b15;
      --border: rgba(255,255,255,.08);
      --text:#f2fff3;
      --muted: rgba(242,255,243,.72);

      --brand:#e53935;
      --brand2:#36c06b;
      --accent:#ffd166;

      --radius:18px;
      --shadow: 0 18px 50px rgba(0,0,0,.55);

      /* ===== Glow colors ===== */
      --glow1: rgba(54,192,107,.45);   /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß */
      --glow2: rgba(229,57,53,.35);    /* ‡πÅ‡∏î‡∏á */
      --glowW: rgba(255,255,255,.35);  /* ‡∏Ç‡∏≤‡∏ß */
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui, -apple-system, Segoe UI, Prompt, sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 0% 0%, rgba(54,192,107,.12), transparent 60%),
        radial-gradient(900px 500px at 100% 0%, rgba(229,57,53,.12), transparent 60%),
        linear-gradient(180deg, var(--bg), #070a08);
      overflow-x:hidden;

      /* text rendering */
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }
    a{color:inherit;text-decoration:none}
    img{max-width:100%;display:block}

    .wrap{max-width:1100px;margin:auto;padding:18px; position:relative; z-index:10;} /* ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏´‡∏¥‡∏°‡∏∞ */

    /* ===== Snow Canvas ===== */
    #snow{
      position:fixed;
      inset:0;
      width:100vw;
      height:100vh;
      pointer-events:none;
      z-index:5;          /* ‡πÉ‡∏ï‡πâ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ ‡πÅ‡∏ï‡πà‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á */
      opacity:.75;        /* ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏ö‡∏≤-‡∏´‡∏ô‡∏±‡∏Å‡πÑ‡∏î‡πâ */
      mix-blend-mode: screen;
    }

    /* Header */
    .header{
      position:sticky; top:12px; z-index:50;
      border:1px solid var(--border);
      background:rgba(15,22,18,.78);
      backdrop-filter: blur(10px);
      border-radius:22px;
      box-shadow:var(--shadow);
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px; min-width:0;
    }
    .logo{
      width:42px;height:42px;border-radius:14px; object-fit:cover;
      box-shadow:0 0 0 1px rgba(255,255,255,.10), 0 12px 30px rgba(0,0,0,.45);
    }
    .brand-title{
      font-weight:900; letter-spacing:.4px; line-height:1.1;
      /* Glow */
      text-shadow:
        0 0 10px var(--glowW),
        0 0 22px rgba(255,255,255,.18),
        0 0 28px rgba(54,192,107,.10);
    }
    .brand-sub{font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:56vw}
    .nav{
      display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; align-items:center;
    }

    .btn{
      border:1px solid var(--border);
      background:rgba(16,27,21,.9);
      color:var(--text);
      padding:10px 14px;
      border-radius:14px;
      font-weight:800;
      cursor:pointer;
      transition:transform .12s ease, opacity .12s ease;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn:active{transform:translateY(0px); opacity:.9}
    .btn.primary{
      border:none;
      color:#140a0a;
      background:linear-gradient(90deg,var(--brand),var(--brand2));
      box-shadow:
        0 12px 30px rgba(0,0,0,.45),
        0 0 22px rgba(54,192,107,.18),
        0 0 18px rgba(229,57,53,.14);
    }
    .btn.ghost{ background:transparent; }
    .btn[disabled]{opacity:.55; pointer-events:none}

    /* Mobile menu */
    .hamburger{display:none}
    @media (max-width: 520px){
      .wrap{padding:14px}
      .brand-sub{display:none}
      .nav{display:none}
      .hamburger{display:inline-flex}
      .menu{
        display:none;
        margin-top:10px;
        border:1px solid var(--border);
        background:rgba(15,22,18,.88);
        border-radius:18px;
        padding:10px;
      }
      .menu.open{display:block}
      .menu .btn{width:100%; justify-content:center; display:flex}
    }

    /* Layout */
    .grid{display:grid; gap:14px}
    .hero{
      margin-top:14px;
      grid-template-columns: 1.2fr .8fr;
      align-items:stretch;
    }
    @media (max-width: 900px){
      .hero{grid-template-columns:1fr}
    }

    .card{
      border:1px solid var(--border);
      background:rgba(16,27,21,.72);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
    }
    .card.soft{
      background:rgba(16,27,21,.55);
      box-shadow:none;
    }

    h1,h2,h3{margin:0}
    /* Glow headings */
    h1, h2, h3{
      text-shadow:
        0 0 10px rgba(255,255,255,.18),
        0 0 20px rgba(54,192,107,.12),
        0 0 26px rgba(229,57,53,.10);
    }

    .muted{color:var(--muted)}
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      border:1px solid var(--border);
      background:rgba(16,27,21,.85);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      font-weight:800;
      text-shadow: 0 0 10px rgba(255,255,255,.18);
    }

    /* h1 highlight glow */
    h1 span{
      text-shadow:
        0 0 12px rgba(255,209,102,.35),
        0 0 26px rgba(255,209,102,.18);
    }

    .kpis{
      margin-top:12px;
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:10px;
    }
    .kpi{
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      background:rgba(15,22,18,.9);
    }
    .kpi .num{
      font-weight:900; font-size:18px;
      text-shadow:
        0 0 12px rgba(54,192,107,.20),
        0 0 22px rgba(255,255,255,.12);
    }
    .kpi .lab{font-size:12px; color:var(--muted); margin-top:2px}

    .strip{
      margin-top:10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 12px;
      background:rgba(15,22,18,.9);
    }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-weight:900;
      text-shadow:
        0 0 12px rgba(54,192,107,.20),
        0 0 22px rgba(255,255,255,.12);
    }

    /* Sections */
    .section{margin-top:16px}
    .section-title{display:flex; align-items:end; justify-content:space-between; gap:10px; flex-wrap:wrap}
    .section-title p{margin:6px 0 0}

    /* Tabs + packages */
    .tabs{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .tab{
      border:1px solid var(--border);
      background:rgba(15,22,18,.9);
      padding:8px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:900;
      font-size:13px;
      color:var(--muted);
    }
    .tab.active{
      color:#140a0a;
      border:none;
      background:linear-gradient(90deg,var(--brand),var(--brand2));
    }

    .pkg-grid{
      margin-top:12px;
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(190px,1fr));
      gap:12px;
    }
    .pkg{
      border:1px solid var(--border);
      background:rgba(15,22,18,.92);
      border-radius:18px;
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:128px;
    }
    .pkg .name{font-weight:900}
    .pkg .price{
      font-weight:950; font-size:20px;
      text-shadow:
        0 0 12px rgba(54,192,107,.18),
        0 0 22px rgba(255,255,255,.10);
    }
    .pkg .actions{margin-top:auto}

    /* Form */
    label{display:block; font-weight:800; font-size:13px; color:rgba(242,255,243,.85); margin-bottom:6px}
    input,select,textarea{
      width:100%;
      background:rgba(11,15,12,.75);
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      color:var(--text);
      outline:none;
    }
    input::placeholder, textarea::placeholder{color:rgba(242,255,243,.45)}

    .two-col{grid-template-columns:1fr 360px; align-items:start}
    @media (max-width: 980px){ .two-col{grid-template-columns:1fr} }

    .row{display:grid; gap:12px; grid-template-columns:1fr 1fr}
    @media (max-width: 650px){ .row{grid-template-columns:1fr} }

    .summary{
      position:sticky; top:92px;
    }
    @media (max-width: 980px){ .summary{position:static} }

    .list{display:flex; flex-direction:column; gap:8px; margin-top:10px}
    .item{display:flex; justify-content:space-between; gap:10px; color:rgba(242,255,243,.88)}
    .total{
      font-weight:950; font-size:22px;
      text-shadow:
        0 0 12px rgba(54,192,107,.20),
        0 0 22px rgba(255,255,255,.12);
    }

    /* History table */
    .table-wrap{
      border:1px solid var(--border);
      border-radius:18px;
      overflow:hidden;
      background:rgba(15,22,18,.85);
    }
    .table-tools{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
      margin:10px 0 0;
    }
    table{width:100%; border-collapse:collapse}
    th,td{padding:10px; border-bottom:1px solid rgba(255,255,255,.06); text-align:left; font-size:14px}
    th{
      color:rgba(255,209,102,.92);
      font-weight:900;
      text-shadow: 0 0 10px rgba(255,209,102,.15);
    }
    .table-scroll{overflow-x:auto; -webkit-overflow-scrolling:touch}
    .table-scroll table{min-width:780px}

    /* Payment cards */
    .pay-grid{
      display:grid; gap:12px;
      grid-template-columns: repeat(auto-fit,minmax(260px,1fr));
      margin-top:12px;
    }
    .paybox{
      border:1px solid var(--border);
      background:rgba(15,22,18,.92);
      border-radius:18px;
      padding:14px;
      text-align:center;
    }
    .paybox img{border-radius:14px}

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      bottom:16px;
      transform:translateX(-50%);
      z-index:80;
      display:none;
      background:rgba(15,22,18,.95);
      border:1px solid var(--border);
      color:var(--text);
      padding:10px 14px;
      border-radius:14px;
      box-shadow:var(--shadow);
      text-shadow: 0 0 10px rgba(255,255,255,.14);
    }
    .toast.show{display:block}

    /* Assistant */
    .assistant-toggle{
      position:fixed;
      right:16px; bottom:16px;
      z-index:70;
      border:none;
      border-radius:999px;
      padding:10px 14px;
      font-weight:950;
      color:#140a0a;
      background:linear-gradient(90deg,var(--brand),var(--brand2));
      box-shadow:0 16px 40px rgba(0,0,0,.55);
      cursor:pointer;
    }
    .assistant{
      position:fixed;
      right:16px; bottom:70px;
      width:320px; max-height:460px;
      display:none;
      flex-direction:column;
      border:1px solid var(--border);
      border-radius:18px;
      background:rgba(15,22,18,.96);
      box-shadow:var(--shadow);
      overflow:hidden;
      z-index:70;
    }
    .assistant.open{display:flex}
    .assistant-head{
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .assistant-title{
      font-weight:950; font-size:14px;
      text-shadow: 0 0 10px rgba(255,255,255,.12);
    }
    .assistant-sub{font-size:11px; color:var(--muted); margin-top:2px}
    .assistant-body{
      padding:10px;
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:8px;
      font-size:13px;
    }
    .bubble{
      max-width:85%;
      padding:8px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(16,27,21,.75);
      text-shadow: 0 0 10px rgba(255,255,255,.08);
    }
    .bubble.me{
      margin-left:auto;
      color:#140a0a;
      border:none;
      background:linear-gradient(90deg,var(--brand),var(--brand2));
      text-shadow:none;
    }
    .assistant-input{
      padding:10px;
      border-top:1px solid rgba(255,255,255,.06);
      display:grid;
      grid-template-columns:1fr auto;
      gap:8px;
      align-items:end;
    }
    .assistant-input textarea{min-height:40px; max-height:90px; resize:none}

    .footer{
      margin:18px 0 6px;
      color:rgba(242,255,243,.55);
      font-size:12px;
      text-align:center;
      text-shadow: 0 0 10px rgba(255,255,255,.08);
    }

    @media (prefers-reduced-motion:reduce){
      *{scroll-behavior:auto !important}
      .btn,.tab{transition:none}
      #snow{display:none;}
      h1,h2,h3,.brand-title,.kpi .num,.total,.mono{ text-shadow:none; }
    }
  </style>
</head>

<body>
  <!-- Snow overlay -->
  <canvas id="snow" aria-hidden="true"></canvas>

  <div class="wrap">
    <!-- Header -->
    <header class="header">
      <div class="brand">
        <img class="logo" src="images/evanvale-logo.png" alt="EVAN VALE" width="42" height="42" decoding="async" fetchpriority="high" />
        <div style="min-width:0">
          <div class="brand-title">EVAN VALE</div>
          <div class="brand-sub">‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Å‡∏°‡πÑ‡∏ß ‚Ä¢ ‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™ ‚Ä¢ ‡∏°‡∏µ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏î‡∏π‡πÅ‡∏•</div>
        </div>
      </div>

      <nav class="nav" aria-label="Primary">
        <a class="btn ghost" href="#packages">‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à</a>
        <a class="btn ghost" href="#order">‡∏™‡∏±‡πà‡∏á‡πÄ‡∏ï‡∏¥‡∏°</a>
        <a class="btn ghost" href="#history">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</a>
        <a class="btn primary" id="btnAdminNav" href="https://www.facebook.com/share/1JRkDmJDvX/" target="_blank" rel="noopener">‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</a>
      </nav>

      <button class="btn hamburger" id="btnMenu" type="button">‡πÄ‡∏°‡∏ô‡∏π</button>
    </header>

    <div class="menu" id="mobileMenu">
      <a class="btn" href="#packages">‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à</a>
      <a class="btn" href="#order">‡∏™‡∏±‡πà‡∏á‡πÄ‡∏ï‡∏¥‡∏°</a>
      <a class="btn" href="#history">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</a>
      <a class="btn primary" href="https://www.facebook.com/share/1JRkDmJDvX/" target="_blank" rel="noopener">‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</a>
    </div>

    <!-- Hero -->
    <section class="grid hero">
      <div class="card">
        <span class="pill">‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå 08:30‚Äì21:30</span>
        <h1 style="margin-top:10px; font-weight:950; letter-spacing:.2px">
          ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Å‡∏°‡πÑ‡∏ß ‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™ <span style="color:var(--accent)">‡∏°‡∏µ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏î‡∏π‡πÅ‡∏•</span>
        </h1>
        <p class="muted" style="margin:8px 0 0">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏û‡πá‡∏Å ‚Üí ‡∏Å‡∏£‡∏≠‡∏Å UID ‚Üí ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ö‡∏¥‡∏• ‚Üí ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</p>

        <div class="strip" id="cdStrip" aria-live="polite">
          <div style="font-weight:900">‚è≥ ‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏™‡∏π‡πà‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà</div>
          <div class="mono" id="countdownDigits">-- ‡∏ß‡∏±‡∏ô --:--:--</div>
        </div>

        <div class="kpis">
          <div class="kpi"><div class="num">3‚Äì10 ‡∏ô‡∏≤‡∏ó‡∏µ*</div><div class="lab">‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</div></div>
          <div class="kpi"><div class="num">1000+</div><div class="lab">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div></div>
          <div class="kpi"><div class="num">0%</div><div class="lab">‡∏¢‡∏∂‡∏î UID</div></div>
        </div>
        <p class="muted" style="margin:10px 0 0; font-size:12px">*‡∏ä‡πà‡∏ß‡∏á‡∏û‡∏µ‡∏Ñ/‡πÄ‡∏Å‡∏°‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏≠‡∏≤‡∏à‡∏ä‡πâ‡∏≤‡∏Å‡∏ß‡πà‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥</p>
      </div>

      <div class="card soft">
        <h3 style="font-weight:950">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏ö‡∏ö‡πÑ‡∏ß ‡πÜ</h3>
        <p class="muted" style="margin:6px 0 0">‡∏Å‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</p>
        <div class="grid" style="margin-top:12px">
          <a class="btn" href="#packages">‡∏î‡∏π‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à</a>
          <a class="btn primary" href="#order">‡πÑ‡∏õ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏ï‡∏¥‡∏°</a>
          <a class="btn" href="#history">‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</a>
        </div>
      </div>
    </section>

    <!-- Packages -->
    <section id="packages" class="section">
      <div class="card">
        <div class="section-title">
          <div>
            <h2 style="font-weight:950">‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à‡∏¢‡∏≠‡∏î‡∏Æ‡∏¥‡∏ï</h2>
            <p class="muted">‡∏Ñ‡∏•‡∏¥‡∏Å ‚Äú‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏û‡πá‡∏Å‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
          </div>
        </div>

        <div class="tabs" id="game-tabs"></div>
        <div class="pkg-grid" id="pkg-grid"></div>
      </div>
    </section>

    <!-- Order + Summary -->
    <section id="order" class="section grid two-col">
      <div class="card">
        <h2 style="font-weight:950">‡∏™‡∏±‡πà‡∏á‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Å‡∏°</h2>

        <div class="row" style="margin-top:12px">
          <div>
            <label>‡πÄ‡∏Å‡∏°</label>
            <select id="game"></select>
            <p id="gameNote" class="muted" style="display:none;margin:8px 0 0"></p>
            <p id="thaiOnlyNote" style="display:none;margin:8px 0 0;border-left:3px solid var(--brand);padding:8px 10px;border-radius:12px;background:rgba(15,22,18,.9)">
              ‚ö†Ô∏è ‡πÄ‡∏Å‡∏°‡∏ô‡∏µ‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ <b>‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏ó‡∏¢</b> ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (Free Fire / RoV / PUBG Mobile / Roblox / Call of Duty)
            </p>
          </div>
          <div>
            <label>‡πÇ‡∏ã‡∏ô/‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå</label>
            <select id="server"></select>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div>
            <label>UID / Player ID</label>
            <input id="uid" placeholder="‡πÄ‡∏ä‡πà‡∏ô 812345678 ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡πÄ‡∏Å‡∏°">
          </div>
          <div>
            <label>‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à</label>
            <select id="package"></select>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div>
            <label>‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞</label>
            <select id="method">
              <option>PromptPay</option>
              <option>TrueMoney Wallet</option>
              <option>‡πÇ‡∏≠‡∏ô‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</option>
            </select>
          </div>
          <div>
            <label>‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
            <input id="promo" placeholder="‡πÄ‡∏ä‡πà‡∏ô EVAN10">
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div>
            <label>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
            <input id="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏Å‡πá‡πÑ‡∏î‡πâ">
          </div>
          <div>
            <label>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</label>
            <input id="contact" placeholder="Line/FB/Tel">
          </div>
        </div>

        <div class="grid" style="grid-template-columns:1fr 1fr 1fr; gap:10px; margin-top:14px">
          <button class="btn" id="btnReset" type="button">‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
          <button class="btn" id="btnSaveProfile" type="button">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
          <button class="btn primary" id="btnSubmit" type="button">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏¥‡∏•</button>
        </div>
        <p class="muted" style="margin:10px 0 0">‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏™‡πà‡∏ß‡∏ô ‚Äú‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‚Äù ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>

        <div id="miniSum" style="display:none; margin-top:14px; border:1px solid var(--border); border-radius:18px; padding:12px; background:rgba(15,22,18,.9)">
          <div style="font-weight:950">‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏£‡πà‡∏≤‡∏ß ‡πÜ</div>
          <div class="list">
            <div class="item"><span class="muted">‡πÄ‡∏Å‡∏°</span><span id="mini-game">-</span></div>
            <div class="item"><span class="muted">‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå</span><span id="mini-server">-</span></div>
            <div class="item"><span class="muted">‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à</span><span id="mini-pkg">-</span></div>
            <div class="item"><span class="muted">‡∏¢‡∏≠‡∏î</span><span id="mini-total">‡∏ø0</span></div>
          </div>
        </div>
      </div>

      <aside class="card summary">
        <h3 style="font-weight:950">‡∏™‡∏£‡∏∏‡∏õ‡∏ö‡∏¥‡∏•</h3>
        <div class="list">
          <div class="item"><span class="muted">‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•</span><span id="sum-bill">-</span></div>
          <div class="item"><span class="muted">‡πÄ‡∏Å‡∏°</span><span id="sum-game">-</span></div>
          <div class="item"><span class="muted">‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå</span><span id="sum-server">-</span></div>
          <div class="item"><span class="muted">UID</span><span id="sum-uid">-</span></div>
          <div class="item"><span class="muted">‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à</span><span id="sum-pkg">-</span></div>
          <div class="item"><span class="muted">‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞</span><span id="sum-method">-</span></div>
        </div>
        <div style="height:1px;background:rgba(255,255,255,.08);margin:12px 0"></div>
        <div class="item"><span class="muted">‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span><span class="total" id="sum-total">‡∏ø0</span></div>
      </aside>
    </section>

    <!-- Payment -->
    <section id="pay" class="section" style="display:none">
      <div class="card">
        <h2 style="font-weight:950">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h2>
        <p class="muted" style="margin:6px 0 0">‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ/‡πÄ‡∏•‡∏Ç‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á ‚Üí ‡∏Å‡∏î ‚Äú‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏™‡∏£‡∏∏‡∏õ‡∏ö‡∏¥‡∏•‚Äù ‚Üí ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ä‡∏ó‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</p>

        <div class="pay-grid">
          <div class="paybox">
            <div style="font-weight:950">TrueMoney Wallet</div>
            <p class="muted" style="margin:6px 0 10px">‡∏™‡πÅ‡∏Å‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÅ‡∏≠‡∏õ TrueMoney</p>
            <img src="truemoney.png" alt="TrueMoney QR" loading="lazy" decoding="async" width="360" height="360">
          </div>
          <div class="paybox">
            <div style="font-weight:950">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå / ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</div>
            <p class="muted" style="margin:6px 0 10px">‡∏™‡πÅ‡∏Å‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÅ‡∏≠‡∏õ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</p>
            <img src="promptpay.png" alt="PromptPay QR" loading="lazy" decoding="async" width="360" height="360">
          </div>
        </div>

        <div class="card soft" style="margin-top:12px">
          <h3 style="font-weight:950">‡πÅ‡∏ô‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</h3>

          <div class="row" style="margin-top:10px">
            <div>
              <label>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ</label>
              <input id="slip" type="file" accept="image/*">
              <div class="muted" style="margin-top:6px; font-size:12px">‡πÄ‡∏ß‡πá‡∏ö‡∏™‡πÅ‡∏ï‡∏ï‡∏¥‡∏Å‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå ‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡∏ö‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡πÅ‡∏ä‡∏ó‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ</div>
            </div>
            <div>
              <label>‡πÄ‡∏•‡∏Ç‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
              <input id="ref" placeholder="‡πÄ‡∏ä‡πà‡∏ô 2025-XX-XX">
            </div>
          </div>

          <div class="grid" style="grid-template-columns:1fr 1fr 1fr 1fr; gap:10px; margin-top:12px">
            <button class="btn" id="btnBackToForm" type="button">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏Å‡πâ‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
            <button class="btn primary" id="btnPrepareMsg" type="button" disabled>‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏™‡∏£‡∏∏‡∏õ‡∏ö‡∏¥‡∏•</button>
            <button class="btn" id="btnMarkPaid" type="button" disabled>‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</button>
            <a class="btn" id="btnOpenAdmin" href="#" target="_blank" rel="noopener" style="pointer-events:none;opacity:.6;display:flex;justify-content:center;align-items:center">‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ä‡∏ó‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</a>
          </div>

          <div id="copyHint" class="muted" style="display:none;margin-top:10px"></div>
          <textarea id="msgPreview" readonly style="display:none;margin-top:10px" rows="8"></textarea>
        </div>
      </div>
    </section>

    <!-- History -->
    <section id="history" class="section">
      <div class="card">
        <h2 style="font-weight:950">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h2>

        <div class="table-tools">
          <input id="histSearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ‡∏ö‡∏¥‡∏•/‡πÄ‡∏Å‡∏°/UID/‡∏ä‡∏∑‡πà‡∏≠" style="max-width:280px">
          <select id="histGameFilter" class="btn" style="padding:10px 12px">
            <option value="">‡∏ó‡∏∏‡∏Å‡πÄ‡∏Å‡∏°</option>
          </select>
          <select id="histStatusFilter" class="btn" style="padding:10px 12px">
            <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
            <option>‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞</option>
            <option>‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏•‡πâ‡∏ß</option>
            <option>‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</option>
            <option>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</option>
          </select>
          <button class="btn" id="btnExportCsv" type="button">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV</button>
          <button class="btn" id="btnClearAll" type="button">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        </div>

        <div class="table-wrap" style="margin-top:12px">
          <div class="table-scroll">
            <table id="histTable">
              <thead>
                <tr>
                  <th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•</th><th>‡πÄ‡∏Å‡∏°</th><th>‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü</th><th>‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à</th><th>‡∏¢‡∏≠‡∏î</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>UID</th><th>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div id="histEmpty" class="muted" style="padding:12px;display:none">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
        </div>
      </div>
    </section>

    <div class="footer">¬© 2025 EVAN VALE ‚Ä¢ Static Topup Page</div>
  </div>

  <!-- Assistant -->
  <div class="assistant" id="evAssistant" aria-label="EVAN AI">
    <div class="assistant-head">
      <div class="assistant-title">EVAN AI (‡πÄ‡∏ö‡∏ï‡πâ‡∏≤)</div>
      <div class="assistant-sub">‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡∏∏‡∏õ‡∏ö‡∏¥‡∏•/‡πÅ‡∏û‡πá‡∏Å ‚Ä¢ ‡∏û‡∏¥‡∏°‡∏û‡πå ‚Äú‡πÄ‡∏Å‡∏° + ‡πÅ‡∏û‡πá‡∏Å + UID‚Äù</div>
    </div>
    <div class="assistant-body" id="evAssistantMessages"></div>
    <div class="assistant-input">
      <textarea id="evAssistantInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°..."></textarea>
      <button class="btn primary" id="evAssistantSend" type="button">‡∏™‡πà‡∏á</button>
    </div>
  </div>
  <button class="assistant-toggle" id="evAssistantToggle" type="button">EVAN ‚Ä¢ Chat</button>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <!-- ‚úÖ SUPABASE (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
   // ====== ‡πÉ‡∏™‡πà‡∏Ç‡∏≠‡∏á‡∏°‡∏∂‡∏á‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ======
    const SUPABASE_URL = "https://cnaukrfxxthemdmavuou.supabase.co";
    const SUPABASE_KEY = "sb_publishable_PJvhWJNhD6YlaAxOMgS9Uw_7bDlSzb4";

    // ====== ‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ ======
    const SB_TABLE_ORDERS = "orders";
    const SB_TABLE_SLIPS  = "slips";
    const SB_BUCKET_SLIPS = "slips"; // ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏õ‡∏™‡∏£‡πâ‡∏≤‡∏á bucket ‡∏ä‡∏∑‡πà‡∏≠ slips ‡πÉ‡∏ô Storage ‡∏Å‡πà‡∏≠‡∏ô

    // init
    window.sb = null;
    try{
      if(SUPABASE_URL && SUPABASE_KEY && !SUPABASE_URL.includes("PASTE_")){
        window.sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
      }
    }catch(e){
      window.sb = null;
    }

    function sbReady(){
      return !!window.sb;
    }
  </script>

<script>
/* ===== STORAGE (no login) ===== */
const KEY_PROFILE = "ev_profile";
const KEY_ORDERS  = "ev_orders";
function loadProfile(){ try{return JSON.parse(localStorage.getItem(KEY_PROFILE)||"null");}catch{return null;} }
function saveProfile(p){ localStorage.setItem(KEY_PROFILE, JSON.stringify(p||null)); }
function loadOrders(){ try{ return JSON.parse(localStorage.getItem(KEY_ORDERS)||"[]"); }catch{return [];} }
function saveOrders(list){ localStorage.setItem(KEY_ORDERS, JSON.stringify(list||[])); }

/* ===== SUPABASE HELPERS (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß) ===== */
async function syncOrderToSupabase(row){
  // row: object ‡∏ó‡∏µ‡πà‡∏°‡∏∂‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≠‡∏ô‡∏Å‡∏î submit
  if(!sbReady()) return { ok:false, reason:"sb_not_ready" };

  try{
    // insert order
    const payload = {
      order_code: row.invoiceId,
      product_name: row.package || "-",
      game_uid: row.uid || null,
      note: JSON.stringify({
        game: row.game,
        server: row.server,
        method: row.method,
        name: row.name,
        contact: row.contact,
        promo: (document.getElementById('promo')?.value || "").trim()
      }),
      amount: Number(String(row.total||"").replace(/[^\d]/g,"")) || 0,
      status: "pending_payment"
    };

    const { data, error } = await window.sb
      .from(SB_TABLE_ORDERS)
      .insert(payload)
      .select("id")
      .single();

    if(error) throw error;

    // ‡πÄ‡∏Å‡πá‡∏ö id ‡∏ó‡∏µ‡πà‡∏ù‡∏±‡πà‡∏á DB ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô row (‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡∏≠‡∏±‡∏õ‡∏™‡∏•‡∏¥‡∏õ)
    row.sb_order_id = data?.id || null;
    return { ok:true, id: row.sb_order_id };
  }catch(err){
    console.warn("Supabase syncOrder error:", err);
    return { ok:false, reason: err?.message || "insert_failed" };
  }
}

async function uploadSlipToSupabase(file, invoiceId){
  if(!sbReady()) return { ok:false, reason:"sb_not_ready" };
  if(!file) return { ok:false, reason:"no_file" };

  try{
    const ext = (file.name.split(".").pop() || "jpg").toLowerCase();
    const safeExt = ["jpg","jpeg","png","webp"].includes(ext) ? ext : "jpg";
    const path = `orders/${invoiceId}/${Date.now()}.${safeExt}`;

    const { error: upErr } = await window.sb
      .storage
      .from(SB_BUCKET_SLIPS)
      .upload(path, file, { upsert: true, contentType: file.type || "image/jpeg" });

    if(upErr) throw upErr;

    return { ok:true, path };
  }catch(err){
    console.warn("Supabase upload slip error:", err);
    return { ok:false, reason: err?.message || "upload_failed" };
  }
}

async function addSlipRecordToSupabase(sbOrderId, filePath){
  if(!sbReady()) return { ok:false, reason:"sb_not_ready" };
  if(!sbOrderId || !filePath) return { ok:false, reason:"missing_data" };

  try{
    const { error } = await window.sb
      .from(SB_TABLE_SLIPS)
      .insert({ order_id: sbOrderId, file_path: filePath });

    if(error) throw error;
    return { ok:true };
  }catch(err){
    console.warn("Supabase insert slip record error:", err);
    return { ok:false, reason: err?.message || "insert_slip_failed" };
  }
}

async function markPaidSupabase(sbOrderId, referenceText){
  if(!sbReady()) return { ok:false, reason:"sb_not_ready" };
  if(!sbOrderId) return { ok:false, reason:"missing_order_id" };

  try{
    const { error } = await window.sb
      .from(SB_TABLE_ORDERS)
      .update({
        status: "paid",
        note: JSON.stringify({ paid_ref: referenceText || "" })
      })
      .eq("id", sbOrderId);

    if(error) throw error;
    return { ok:true };
  }catch(err){
    console.warn("Supabase mark paid error:", err);
    return { ok:false, reason: err?.message || "update_failed" };
  }
}

/* ===== DATA ===== */
const ADMIN_URL = "https://www.facebook.com/share/1JRkDmJDvX/";
const GAMES = [
  { key:"Free Fire", icon:"üî•", servers:["Thailand","SEA","Global","‡∏≠‡∏∑‡πà‡∏ô‡πÜ"] },
  { key:"Free Fire (‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà)", icon:"üî•", servers:["Thailand","SEA","Global","‡∏≠‡∏∑‡πà‡∏ô‡πÜ"] },
  { key:"RoV", icon:"üõ°Ô∏è", servers:["Thailand","Vietnam","Taiwan","‡∏≠‡∏∑‡πà‡∏ô‡πÜ"] },
  { key:"Genshin Impact", icon:"‚ú®", servers:["‡πÄ‡∏≠‡πÄ‡∏ä‡∏µ‡∏¢ (Asia)","‡∏≠‡πÄ‡∏°‡∏£‡∏¥‡∏Å‡∏≤ (America)","‡∏¢‡∏∏‡πÇ‡∏£‡∏õ (Europe)","TW, HK, MO","‡∏≠‡∏∑‡πà‡∏ô‡πÜ"] },
  { key:"Honkai: Star Rail", icon:"üöÑ", servers:["‡πÄ‡∏≠‡πÄ‡∏ä‡∏µ‡∏¢ (Asia)","‡∏≠‡πÄ‡∏°‡∏£‡∏¥‡∏Å‡∏≤ (America)","‡∏¢‡∏∏‡πÇ‡∏£‡∏õ (Europe)","TW, HK, MO","‡∏≠‡∏∑‡πà‡∏ô‡πÜ"] },
  { key:"PUBG Mobile", icon:"üéØ", servers:["Thailand","SEA","KRJP","Global","‡∏≠‡∏∑‡πà‡∏ô‡πÜ"] },
  { key:"Roblox", icon:"üß±", servers:["Thailand","Asia","USA","Global","‡∏≠‡∏∑‡πà‡∏ô‡πÜ"] },
  { key:"Roblox (‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà)", icon:"üéÅ", servers:["Thailand","Asia","USA","Global","‡∏≠‡∏∑‡πà‡∏ô‡πÜ"] },
  { key:"Call of Duty", icon:"üéÆ", servers:["Thailand","SEA","Global","‡∏≠‡∏∑‡πà‡∏ô‡πÜ"] },
  { key:"Wuthering Waves", icon:"üåä", servers:["‡πÄ‡∏≠‡πÄ‡∏ä‡∏µ‡∏¢ (Asia)","‡∏≠‡πÄ‡∏°‡∏£‡∏¥‡∏Å‡∏≤ (America)","‡∏¢‡∏∏‡πÇ‡∏£‡∏õ (Europe)","TW, HK, MO","‡∏≠‡∏∑‡πà‡∏ô‡πÜ"] },
];
const PACKS_BY_GAME = {
  "Free Fire": [
    {name:"33 ‡πÄ‡∏û‡∏ä‡∏£",price:11},{name:"68 ‡πÄ‡∏û‡∏ä‡∏£",price:21},{name:"172 ‡πÄ‡∏û‡∏ä‡∏£",price:49},
    {name:"310 ‡πÄ‡∏û‡∏ä‡∏£",price:87},{name:"517 ‡πÄ‡∏û‡∏ä‡∏£",price:145},{name:"690 ‡πÄ‡∏û‡∏ä‡∏£",price:195},
    {name:"1052 ‡πÄ‡∏û‡∏ä‡∏£",price:290},{name:"1800 ‡πÄ‡∏û‡∏ä‡∏£",price:480},{name:"3698 ‡πÄ‡∏û‡∏ä‡∏£",price:950},
    {name:"7396 ‡πÄ‡∏û‡∏ä‡∏£",price:1900},{name:"‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏î‡∏≤‡∏°‡∏¥‡∏ô‡∏¥",price:32},{name:"‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏î‡∏≤",price:63},
    {name:"‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô",price:287},{name:"‡∏ö‡∏π‡∏¢‡πà‡∏≤‡∏´‡πå‡∏û‡∏≤‡∏™",price:90},{name:"‡∏≠‡∏µ‡πÇ‡∏ß‡∏û‡∏≤‡∏™ 3 ‡∏ß‡∏±‡∏ô",price:46},
    {name:"‡∏≠‡∏µ‡πÇ‡∏ß‡∏û‡∏≤‡∏™ 7 ‡∏ß‡∏±‡∏ô",price:62},{name:"‡∏≠‡∏µ‡πÇ‡∏ß‡∏û‡∏≤‡∏™ 30 ‡∏ß‡∏±‡∏ô",price:220}
  ],
  "Free Fire (‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà)": [
    {name:"33 ‡πÄ‡∏û‡∏ä‡∏£",price:10},{name:"68 ‡πÄ‡∏û‡∏ä‡∏£",price:19},{name:"172 ‡πÄ‡∏û‡∏ä‡∏£",price:48},
    {name:"310 ‡πÄ‡∏û‡∏ä‡∏£",price:85},{name:"517 ‡πÄ‡∏û‡∏ä‡∏£",price:143},{name:"690 ‡πÄ‡∏û‡∏ä‡∏£",price:190},
    {name:"1052 ‡πÄ‡∏û‡∏ä‡∏£",price:284},{name:"1800 ‡πÄ‡∏û‡∏ä‡∏£",price:474},
    {name:"3698 ‡πÄ‡∏û‡∏ä‡∏£",price:945},{name:"7396 ‡πÄ‡∏û‡∏ä‡∏£",price:1890}
  ],
  "RoV": [
    {name:"11 ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á",price:10},{name:"24 ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á",price:19},{name:"60 ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á",price:49},
    {name:"110 ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á",price:87},{name:"185 ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á",price:144},{name:"370 ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á",price:285},
    {name:"620 ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á",price:478},{name:"990 ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á",price:765},{name:"1250 ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á",price:960}
  ],
  "Genshin Impact": [
    {name:"60 Genesis Crystals",price:30},{name:"300+30 Genesis Crystals",price:145},
    {name:"980+110 Genesis Crystals",price:420},{name:"1980+260 Genesis Crystals",price:870},
    {name:"3280+600 Genesis Crystals",price:1340},{name:"6480+1600 Genesis Crystals",price:2625},
    {name:"Blessing (‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)",price:179}
  ],
  "Honkai: Star Rail": [
    {name:"60 Oneiric Shard",price:35},{name:"300+30 Shard",price:145},
    {name:"980+110 Shard",price:425},{name:"1980+260 Shard",price:870},
    {name:"3280+600 Shard",price:1340},{name:"6480+1600 Shard",price:2630},
    {name:"Express Supply Pass",price:145}
  ],
  "PUBG Mobile": [
    {name:"60 UC",price:35},{name:"325 UC",price:179},{name:"660 UC",price:346},
    {name:"1800 UC",price:860},{name:"3850 UC",price:1696},{name:"8100 UC",price:3305},
    {name:"16200 UC",price:6475},{name:"24300 UC",price:9910}
  ],
  "Roblox": [
    {name:"80 Robux",price:35},{name:"160 Robux",price:70},{name:"400 Robux",price:175},
    {name:"800 Robux",price:350},{name:"1000 Robux",price:400},{name:"2000 Robux",price:600},
    {name:"4000 Robux",price:1200},{name:"‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô 1000 Robux",price:380}
  ],
  "Roblox (‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà)": [
    {name:"500 Robux (‡∏à‡∏≤‡∏Å 230 ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 160)",price:160},
    {name:"1000 Robux (‡∏à‡∏≤‡∏Å 500 ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 320)",price:320},
    {name:"2000 Robux (‡∏à‡∏≤‡∏Å 960 ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 620)",price:620},
    {name:"3000 Robux (‡∏à‡∏≤‡∏Å 1000 ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 910)",price:910}
  ],
  "Call of Duty": [
    {name:"44 ‡πÇ‡∏ö‡∏ô‡∏±‡∏™ 10 CP",price:22},{name:"108 ‡πÇ‡∏ö‡∏ô‡∏±‡∏™ 30 CP",price:52},{name:"194 ‡πÇ‡∏ö‡∏ô‡∏±‡∏™ 55 CP",price:90},
    {name:"324 ‡πÇ‡∏ö‡∏ô‡∏±‡∏™ 90 CP",price:152},{name:"648 ‡πÇ‡∏ö‡∏ô‡∏±‡∏™ 216 CP",price:305},
    {name:"1080 ‡πÇ‡∏ö‡∏ô‡∏±‡∏™ 480 CP",price:505},{name:"2160 ‡πÇ‡∏ö‡∏ô‡∏±‡∏™ 1080 CP",price:1010}
  ],
  "Wuthering Waves": [
    {name:"60 Lunite",price:35},{name:"300+30 Lunite",price:179},
    {name:"980+110 Lunite",price:549},{name:"Lunite Pass (‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)",price:179}
  ]
};

/* ===== REFS ===== */
const tabs = document.getElementById('game-tabs');
const pkgGrid = document.getElementById('pkg-grid');
const selGame = document.getElementById('game');
const selServer = document.getElementById('server');
const selPackage = document.getElementById('package');

const miniSum = document.getElementById('miniSum');
const miniGame = document.getElementById('mini-game');
const miniServer = document.getElementById('mini-server');
const miniPkg = document.getElementById('mini-pkg');
const miniTotal = document.getElementById('mini-total');

const gameNote = document.getElementById('gameNote');
const thaiOnlyNote = document.getElementById('thaiOnlyNote');

let currentGame = GAMES[0].key;
const thaiOnlyGames = ["Free Fire","RoV","PUBG Mobile","Roblox","Call of Duty"];

/* ===== Mobile Menu ===== */
const btnMenu = document.getElementById('btnMenu');
const mobileMenu = document.getElementById('mobileMenu');
btnMenu?.addEventListener('click', ()=> mobileMenu.classList.toggle('open'));
mobileMenu?.querySelectorAll('a').forEach(a=>{
  a.addEventListener('click', ()=> mobileMenu.classList.remove('open'));
});

/* ===== UI: Packages ===== */
function renderGameTabs(){
  tabs.innerHTML = ""; selGame.innerHTML = "";
  GAMES.forEach(g=>{
    const t = document.createElement('div');
    t.className = 'tab' + (g.key===currentGame?' active':'');
    t.textContent = `${g.icon} ${g.key}`;
    t.addEventListener('click', ()=> setGame(g.key));
    tabs.appendChild(t);

    const opt = document.createElement('option');
    opt.value = g.key; opt.textContent = g.key;
    selGame.appendChild(opt);
  });
  selGame.value = currentGame;
}
function renderServers(){
  selServer.innerHTML = "";
  const gs = GAMES.find(x=>x.key===currentGame)?.servers || ["Global"];
  gs.forEach(s=>{
    const o=document.createElement('option'); o.value=s; o.textContent=s;
    selServer.appendChild(o);
  });
}
function renderPacks(){
  const packs = PACKS_BY_GAME[currentGame]||[];
  pkgGrid.innerHTML = "";
  selPackage.innerHTML = "<option value='' disabled selected>‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à ‚Äî</option>";

  packs.forEach(p=>{
    const card = document.createElement('div');
    card.className = "pkg";
    card.innerHTML = `
      <div class="name">${p.name}</div>
      <div class="price">‡∏ø${p.price}</div>
      <div class="actions">
        <a href="#order" class="btn primary" data-pkg="${p.name} ‚Äì ‡∏ø${p.price}">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏û‡πá‡∏Å</a>
      </div>`;
    pkgGrid.appendChild(card);

    const opt = document.createElement('option');
    opt.value = `${p.name} ‚Äì ‡∏ø${p.price}`;
    opt.textContent = `${p.name} ‚Äì ‡∏ø${p.price}`;
    selPackage.appendChild(opt);
  });

  pkgGrid.querySelectorAll('a[data-pkg]').forEach(a=>{
    a.addEventListener('click',e=>{
      e.preventDefault();
      selPackage.value = a.getAttribute('data-pkg');
      document.getElementById('order').scrollIntoView({behavior:'smooth'});
      updateSummary();
    });
  });
}
function setGame(game){
  currentGame = game;

  // tabs UI
  [...tabs.children].forEach((el, i)=>{
    el.classList.toggle('active', GAMES[i].key===currentGame);
  });

  const isPromo = /‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô/.test(currentGame);

  if (currentGame === "Roblox"){
    gameNote.style.display = "block";
    gameNote.textContent = "‚ÑπÔ∏è Roblox: ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡∏≤‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏°‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ (‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÄ‡∏ß‡∏•‡∏≤)";
  } else if (currentGame === "Call of Duty"){
    gameNote.style.display = "block";
    gameNote.textContent = "‚ö†Ô∏è COD: ‡∏ñ‡πâ‡∏≤ ID ‡∏ú‡∏π‡∏Å‡∏Å‡∏±‡∏ö Garena ‡∏à‡∏∞‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÑ‡∏ó‡∏¢)";
  } else if (isPromo){
    gameNote.style.display = "block";
    gameNote.textContent = "üéÅ ‡πÇ‡∏õ‡∏£‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà: ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏Ñ‡∏∑‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß";
    promoHintOnce();
  } else {
    gameNote.style.display="none";
    gameNote.textContent="";
  }

  thaiOnlyNote.style.display = thaiOnlyGames.includes(currentGame) ? "block" : "none";

  selGame.value = game;
  renderServers();
  renderPacks();
  updateSummary();
  showMini();
}
function showMini(){
  const has = (selPackage.value||"").length>0 || (document.getElementById('uid').value||"").length>0;
  miniSum.style.display = has ? "block" : "none";
}

/* ===== SUMMARY / BILL ===== */
const pad = n => n.toString().padStart(2,'0');
function genInvoice(){
  const d = new Date();
  const ts = `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}-${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
  const rnd = Math.floor(Math.random()*8999)+1000;
  return `EV-${ts}-${rnd}`;
}
function money(n){ return "‡∏ø"+(n||0); }
function updateSummary(){
  const g = selGame.value;
  const s = selServer.value;
  const u = document.getElementById('uid').value || "-";
  const p = selPackage.value || "-";
  const m = document.getElementById('method').value;

  document.getElementById('sum-game').innerText   = g;
  document.getElementById('sum-server').innerText = s || "-";
  document.getElementById('sum-uid').innerText    = u;
  document.getElementById('sum-pkg').innerText    = p;
  document.getElementById('sum-method').innerText = m;

  const price = Number((p.split("‡∏ø")[1] || "0").replace(/[^\d]/g,""));
  const totalTxt = money(price);
  document.getElementById('sum-total').innerText = totalTxt;

  miniGame.textContent = g;
  miniServer.textContent = s || "-";
  miniPkg.textContent = p;
  miniTotal.textContent = totalTxt;

  showMini();
}
["game","server","uid","package","method","name","contact","promo"].forEach(id=>{
  const el = document.getElementById(id);
  el.addEventListener('input', updateSummary);
  el.addEventListener('change', updateSummary);
});

/* ===== HISTORY ===== */
function addOrder(row){ const list=loadOrders(); list.unshift(row); saveOrders(list); renderHistory(); }
function updateOrderStatus(inv, status){
  const list=loadOrders(); const idx=list.findIndex(x=>x.invoiceId===inv);
  if(idx>-1){ list[idx].status=status; saveOrders(list); renderHistory(); }
}
function patchOrder(inv, patch){
  const list = loadOrders();
  const idx = list.findIndex(x=>x.invoiceId===inv);
  if(idx>-1){
    list[idx] = { ...list[idx], ...patch };
    saveOrders(list);
    renderHistory();
  }
}
function deleteOrder(inv){
  const list=loadOrders().filter(x=>x.invoiceId!==inv);
  saveOrders(list); renderHistory();
}
function clearAll(){
  if(confirm('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ö‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ? (‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå/‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥/‡∏ó‡∏¥‡∏õ‡πÇ‡∏õ‡∏£)')){
    localStorage.removeItem(KEY_PROFILE);
    localStorage.removeItem(KEY_ORDERS);
    localStorage.removeItem('ev_promo_hint_shown');
    location.reload();
  }
}
const histTableBody = document.querySelector('#histTable tbody');
const histEmpty = document.getElementById('histEmpty');
const histSearch = document.getElementById('histSearch');
const histGameFilter = document.getElementById('histGameFilter');
const histStatusFilter = document.getElementById('histStatusFilter');

function initHistoryFilters(){
  histGameFilter.innerHTML = '<option value="">‡∏ó‡∏∏‡∏Å‡πÄ‡∏Å‡∏°</option>' + GAMES.map(g=>`<option>${g.key}</option>`).join('');
  [histSearch,histGameFilter,histStatusFilter].forEach(el=>{
    el.addEventListener('input', renderHistory);
    el.addEventListener('change', renderHistory);
  });
}
function renderHistory(){
  const q = (histSearch.value||"").toLowerCase();
  const g = histGameFilter.value||"";
  const st= histStatusFilter.value||"";
  const list = loadOrders().filter(x=>{
    const inTxt = (x.invoiceId+x.game+x.uid+(x.name||"")+(x.package||"")).toLowerCase().includes(q);
    const gOk = g? x.game===g : true;
    const sOk = st? x.status===st : true;
    return inTxt && gOk && sOk;
  });

  histTableBody.innerHTML = "";
  histEmpty.style.display = list.length? "none":"block";

  list.forEach(x=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${new Date(x.ts).toLocaleString()}</td>
      <td>${x.invoiceId}${x.sb_order_id ? " ‚úÖ" : ""}</td>
      <td>${x.game}</td>
      <td>${x.server||"-"}</td>
      <td>${x.package||"-"}</td>
      <td>${x.total||"‡∏ø0"}</td>
      <td>
        <select data-inv="${x.invoiceId}">
          ${["‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞","‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏•‡πâ‡∏ß","‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß","‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å"].map(s=>`<option ${x.status===s?"selected":""}>${s}</option>`).join('')}
        </select>
      </td>
      <td>${x.uid||"-"}</td>
      <td>
        <button class="btn" data-view="${x.invoiceId}" type="button">‡∏î‡∏π</button>
        <button class="btn" data-del="${x.invoiceId}" type="button">‡∏•‡∏ö</button>
      </td>`;
    histTableBody.appendChild(tr);
  });

  histTableBody.querySelectorAll('button[data-del]').forEach(b=>{
    b.onclick = ()=> deleteOrder(b.getAttribute('data-del'));
  });
  histTableBody.querySelectorAll('button[data-view]').forEach(b=>{
    b.onclick = ()=>{
      const inv = b.getAttribute('data-view');
      const x = loadOrders().find(o=>o.invoiceId===inv);
      if(!x) return;
      alert(
`‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•: ${x.invoiceId}
‡πÄ‡∏ß‡∏•‡∏≤: ${new Date(x.ts).toLocaleString()}
‡πÄ‡∏Å‡∏°: ${x.game}
‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå: ${x.server||"-"}
‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à: ${x.package||"-"}
‡∏¢‡∏≠‡∏î: ${x.total||"‡∏ø0"}
‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞: ${x.method}
UID: ${x.uid||"-"}
‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${x.name||"-"} | ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠: ${x.contact||"-"}
‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${x.status}
Supabase: ${x.sb_order_id ? "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß ‚úÖ" : "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°"}`
      );
    };
  });
  histTableBody.querySelectorAll('select[data-inv]').forEach(s=>{
    s.onchange = ()=> updateOrderStatus(s.getAttribute('data-inv'), s.value);
  });
}

/* ===== MESSAGE / COPY ===== */
function buildMessage(){
  const g = selGame.value, s = selServer.value, u = document.getElementById('uid').value || "-";
  const p = selPackage.value || "-", m = document.getElementById('method').value;
  const name = document.getElementById('name').value || "-", contact = document.getElementById('contact').value || "-";
  const total = document.getElementById('sum-total').innerText || "‡∏ø0";
  const ref = (document.getElementById('ref')?.value || "").trim();
  return `‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Å‡∏° Evan Vale
‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•: ${window.invoiceId}
‡πÄ‡∏Å‡∏°: ${g}
‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå/‡πÇ‡∏ã‡∏ô: ${s || "-"}
UID/Player ID: ${u}
‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à: ${p}
‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞: ${m}
‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: ${total}
‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${name}
‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠: ${contact}
‡πÄ‡∏•‡∏Ç‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á: ${ref||"-"}
‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö`;
}
const btnPrepare   = document.getElementById('btnPrepareMsg');
const btnOpenAdmin = document.getElementById('btnOpenAdmin');
const msgPreview   = document.getElementById('msgPreview');
const copyHint     = document.getElementById('copyHint');

function makeAdminUrl(){ return ADMIN_URL; }
async function copyTextSafe(text){
  try{ await navigator.clipboard.writeText(text); return true; }
  catch{
    const ta = document.createElement('textarea'); ta.value = text; ta.style.position='fixed'; ta.style.opacity='0';
    document.body.appendChild(ta); ta.focus(); ta.select();
    let ok=false; try{ ok=document.execCommand('copy'); }catch{}
    document.body.removeChild(ta); return !!ok;
  }
}
btnPrepare?.addEventListener('click', async ()=>{
  if(!window.invoiceId || window.invoiceId === '-'){ alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏¥‡∏•'); return; }
  const msg = buildMessage();
  msgPreview.value = msg; msgPreview.style.display = 'block';
  copyHint.style.display = 'block';
  copyHint.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏™‡∏£‡∏∏‡∏õ‡∏ö‡∏¥‡∏•...';

  const copied = await copyTextSafe(msg);
  copyHint.textContent = copied
    ? '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏™‡∏£‡∏∏‡∏õ‡∏ö‡∏¥‡∏•‡πÅ‡∏•‡πâ‡∏ß ‚úÖ ‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏Å‡∏î ‚Äú‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ä‡∏ó‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‚Äù ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢'
    : '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÉ‡∏´‡πâ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏Å‡∏î ‚Äú‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ä‡∏ó‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‚Äù';

  btnOpenAdmin.href = makeAdminUrl();
  btnOpenAdmin.style.pointerEvents = 'auto';
  btnOpenAdmin.style.opacity = '1';

  if(window.invoiceId){ updateOrderStatus(window.invoiceId, '‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏•‡πâ‡∏ß'); }
});
btnOpenAdmin?.addEventListener('click', (e)=>{
  if (!btnOpenAdmin.href || btnOpenAdmin.getAttribute('href') === '#'){
    e.preventDefault(); window.open(makeAdminUrl(), '_blank');
  }
});

/* ===== FORM ACTIONS ===== */
document.getElementById('btnReset')?.addEventListener('click', ()=>{
  document.querySelectorAll('#order input').forEach(i=>i.value="");
  selPackage.selectedIndex = 0; updateSummary();
});
window.invoiceId = "-";

document.getElementById('btnSubmit')?.addEventListener('click', async ()=>{
  if(!selPackage.value){ alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à‡∏Å‡πà‡∏≠‡∏ô'); return; }

  window.invoiceId = genInvoice();
  document.getElementById('sum-bill').innerText = window.invoiceId;

  const pay = document.getElementById('pay');
  pay.style.display = "";
  pay.scrollIntoView({behavior:'smooth'});

  const row = {
    ts: Date.now(),
    invoiceId: window.invoiceId,
    game: selGame.value,
    server: selServer.value,
    package: selPackage.value,
    total: document.getElementById('sum-total').innerText,
    method: document.getElementById('method').value,
    uid: document.getElementById('uid').value.trim(),
    name: document.getElementById('name').value.trim(),
    contact: document.getElementById('contact').value.trim(),
    status: '‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞',
    sb_order_id: null,
    sb_slip_path: null
  };

  // ‡πÄ‡∏Å‡πá‡∏ö local ‡∏Å‡πà‡∏≠‡∏ô (‡∏Å‡∏±‡∏ô‡∏û‡∏±‡∏á)
  addOrder(row);

  // ‚úÖ sync ‡∏Ç‡∏∂‡πâ‡∏ô Supabase (‡∏ñ‡πâ‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°)
  const res = await syncOrderToSupabase(row);
  if(res.ok){
    patchOrder(row.invoiceId, { sb_order_id: row.sb_order_id });
    toast('‡∏ö‡∏¥‡∏•‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‚úÖ');
  }else{
    // ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° / RLS ‡∏ö‡∏•‡πá‡∏≠‡∏Å ‡∏Å‡πá‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏î‡πâ
    toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß (Supabase ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°) ‚ö†Ô∏è');
  }

  btnPrepare.disabled = false;
  updateMarkPaidState();
});

document.getElementById('btnBackToForm')?.addEventListener('click', ()=>{
  document.getElementById('pay').style.display = "none";
  document.getElementById('order').scrollIntoView({behavior:'smooth'});
});

/* ===== EXPORT / CLEAR ===== */
document.getElementById('btnExportCsv')?.addEventListener('click', ()=>{
  const list = loadOrders();
  if(!list.length){ alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'); return; }
  const header = ["‡πÄ‡∏ß‡∏•‡∏≤","‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•","‡πÄ‡∏Å‡∏°","‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü","‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à","‡∏¢‡∏≠‡∏î","‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞","UID","‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤","‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠"].join(",");
  const rows = list.map(x=>[
    new Date(x.ts).toLocaleString().replaceAll(","," "),
    x.invoiceId, x.game, x.server||"-", x.package||"-",
    (x.total||"‡∏ø0").replaceAll(",",""),
    x.status, x.uid||"-", x.name||"-", x.contact||"-"
  ].map(v=>`"${String(v).replaceAll('"','""')}"`).join(","));
  const csv = [header, ...rows].join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'evan_orders.csv'; a.click();
  URL.revokeObjectURL(url);
});
document.getElementById('btnClearAll')?.addEventListener('click', clearAll);

/* ===== PROFILE SAVE/FILL (no login) ===== */
function fillFromProfile(){
  const p = loadProfile(); if(!p) return;
  if(p.name)    document.getElementById('name').value = p.name;
  if(p.contact) document.getElementById('contact').value = p.contact;
  if(p.last){
    if(p.last.game && GAMES.find(g=>g.key===p.last.game)){ setGame(p.last.game); }
    if(p.last.server){ selServer.value = p.last.server; }
    if(p.last.package){ selPackage.value = p.last.package; }
    if(p.last.method){ document.getElementById('method').value = p.last.method; }
    if(p.last.uid){ document.getElementById('uid').value = p.last.uid; }
  }
  updateSummary();
}
document.getElementById('btnSaveProfile')?.addEventListener('click', ()=>{
  const p = loadProfile() || {};
  p.name = document.getElementById('name').value.trim();
  p.contact = document.getElementById('contact').value.trim();
  p.last = {
    game: selGame.value, server: selServer.value, package: selPackage.value,
    method: document.getElementById('method').value, uid: document.getElementById('uid').value.trim()
  };
  saveProfile(p);
  toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß ‚úÖ');
});

/* ===== MARK AS PAID ===== */
const slipInput = document.getElementById('slip');
const refInput  = document.getElementById('ref');
const btnMarkPaid = document.getElementById('btnMarkPaid');

function canMarkPaid(){
  const hasSlip = slipInput && slipInput.files && slipInput.files.length > 0;
  const hasRef  = (refInput?.value || '').trim().length > 0;
  return !!window.invoiceId && window.invoiceId !== '-' && (hasSlip || hasRef);
}
function updateMarkPaidState(){
  btnMarkPaid.disabled = !canMarkPaid();
}
slipInput?.addEventListener('change', updateMarkPaidState);
refInput?.addEventListener('input', updateMarkPaidState);

btnMarkPaid?.addEventListener('click', async ()=>{
  if(!window.invoiceId || window.invoiceId==='-'){ alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•'); return; }
  if(!canMarkPaid()){ alert('‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏Å‡πà‡∏≠‡∏ô'); return; }

  const refText = (refInput?.value || "").trim();
  const file = (slipInput?.files && slipInput.files[0]) ? slipInput.files[0] : null;

  // update local ‡∏Å‡πà‡∏≠‡∏ô
  updateOrderStatus(window.invoiceId, '‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß');

  // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° Supabase ‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡∏≠‡∏±‡∏õ‡∏™‡∏•‡∏¥‡∏õ + update status
  const x = loadOrders().find(o=>o.invoiceId===window.invoiceId);
  if(x?.sb_order_id && sbReady()){
    // 1) upload slip (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    let slipPath = null;
    if(file){
      const up = await uploadSlipToSupabase(file, window.invoiceId);
      if(up.ok){
        slipPath = up.path;
        patchOrder(window.invoiceId, { sb_slip_path: slipPath });
        // 2) insert slips record
        await addSlipRecordToSupabase(x.sb_order_id, slipPath);
      }else{
        toast('‡∏≠‡∏±‡∏õ‡∏™‡∏•‡∏¥‡∏õ‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô (Storage/RLS ‡∏ö‡∏•‡πá‡∏≠‡∏Å) ‚ö†Ô∏è');
      }
    }

    // 3) mark paid
    const upPaid = await markPaidSupabase(x.sb_order_id, refText || "");
    if(upPaid.ok) toast('‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß ‚úÖ (Sync ‡∏Ç‡∏∂‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß)');
    else toast('‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß ‚úÖ (‡πÅ‡∏ï‡πà Sync DB ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô) ‚ö†Ô∏è');
  }else{
    toast('‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß ‚úÖ (‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)');
  }
});

/* ===== COUNTDOWN (New Year 2026, Asia/Bangkok) ===== */
const cdDigits = document.getElementById('countdownDigits');
function fmt2(n){ return n.toString().padStart(2,'0'); }
(function runCountdown(){
  const target = new Date('2026-01-01T00:00:00+07:00').getTime();
  function tick(){
    const now = Date.now();
    let diff = target - now;
    if(diff <= 0){
      cdDigits.textContent = '00 ‡∏ß‡∏±‡∏ô 00:00:00';
      return;
    }
    const d = Math.floor(diff / 86400000); diff %= 86400000;
    const h = Math.floor(diff / 3600000);  diff %= 3600000;
    const m = Math.floor(diff / 60000);    diff %= 60000;
    const s = Math.floor(diff / 1000);
    cdDigits.textContent = `${fmt2(d)} ‡∏ß‡∏±‡∏ô ${fmt2(h)}:${fmt2(m)}:${fmt2(s)}`;
    setTimeout(tick, 1000);
  }
  tick();
})();

/* ===== TOAST ===== */
function toast(msg){
  const t = document.getElementById('toast');
  if(!t) return;
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(()=> t.classList.remove('show'), 2200);
}
function promoHintOnce(){
  const K = 'ev_promo_hint_shown';
  if(localStorage.getItem(K) === '1') return;
  localStorage.setItem(K, '1');
  toast('üéÅ ‡πÇ‡∏õ‡∏£‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‚Äî ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏Ñ‡∏∑‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß');
}

/* ===== MINI ASSISTANT ===== */
const asToggle = document.getElementById('evAssistantToggle');
const asBox = document.getElementById('evAssistant');
const asMsgWrap = document.getElementById('evAssistantMessages');
const asInput = document.getElementById('evAssistantInput');
const asSend = document.getElementById('evAssistantSend');

function addAssistantBubble(role, text){
  const bubble = document.createElement('div');
  bubble.className = 'bubble' + (role==='user' ? ' me' : '');
  bubble.textContent = text;
  asMsgWrap.appendChild(bubble);
  asMsgWrap.scrollTop = asMsgWrap.scrollHeight;
}
function pickRandom(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
const NORMAL_REPLIES = [
  "‡∏ö‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏¥‡∏•/‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏°/‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à/UID ‡∏°‡∏≤ ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡∏∏‡∏õ‡πÉ‡∏´‡πâ",
  "‡∏ñ‡πâ‡∏≤‡∏à‡∏∞‡∏™‡∏±‡πà‡∏á‡πÄ‡∏ï‡∏¥‡∏°: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏û‡πá‡∏Å ‚Üí ‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏¥‡∏• ‚Üí ‡πÑ‡∏õ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô",
  "‡∏Å‡∏î ‚Äú‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏™‡∏£‡∏∏‡∏õ‡∏ö‡∏¥‡∏•‚Äù ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡∏ß‡∏≤‡∏á‡πÉ‡∏ô‡πÅ‡∏ä‡∏ó‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢",
];
const STRICT_REPLIES = [
  "‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏ô‡∏∞ ‡πÄ‡∏≠‡∏≤‡πÅ‡∏Ñ‡πà ‚Äú‡πÄ‡∏Å‡∏° + ‡πÅ‡∏û‡πá‡∏Å + UID‚Äù ‡∏û‡∏≠",
  "‡πÉ‡∏à‡πÄ‡∏¢‡πá‡∏ô ‡πÜ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡πÑ‡∏ß",
];
const BAD_WORDS = ["‡∏Ñ‡∏ß‡∏¢","‡πÄ‡∏´‡∏µ‡πâ‡∏¢","‡∏™‡∏±‡∏™","fuck","shit"];
function looksGibberish(t){
  const s = (t||"").trim();
  if(!s) return false;
  const letters = s.replace(/[0-9\s\W_]/g,'');
  return letters.length>0 && (letters.length/s.length) < 0.25;
}
function handleAssistantSend(){
  const txt = (asInput.value||"").trim();
  if(!txt) return;
  addAssistantBubble('user', txt);
  asInput.value = "";

  const lower = txt.toLowerCase();
  const hasBad = BAD_WORDS.some(w => lower.includes(w));
  const gib = looksGibberish(txt);
  const reply = (hasBad || gib) ? pickRandom(STRICT_REPLIES) : pickRandom(NORMAL_REPLIES);
  setTimeout(()=> addAssistantBubble('bot', reply), 180);
}
asToggle?.addEventListener('click', ()=>{
  const opened = asBox.classList.toggle('open');
  if(opened && !asMsgWrap.dataset.welcomed){
    asMsgWrap.dataset.welcomed="1";
    addAssistantBubble('bot', "‡∏û‡∏¥‡∏°‡∏û‡πå ‚Äú‡πÄ‡∏Å‡∏° + ‡πÅ‡∏û‡πá‡∏Å + UID‚Äù ‡∏°‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢");
  }
});
asSend?.addEventListener('click', handleAssistantSend);
asInput?.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter' && !e.shiftKey){
    e.preventDefault();
    handleAssistantSend();
  }
});

/* ===== SNOW (lightweight canvas) ===== */
(function snowInit(){
  const c = document.getElementById('snow');
  if(!c) return;

  // ‡∏ñ‡πâ‡∏≤ reduce motion: ‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ô
  const mq = window.matchMedia('(prefers-reduced-motion: reduce)');
  if(mq.matches) return;

  const ctx = c.getContext('2d', { alpha:true });
  const DPR = Math.min(window.devicePixelRatio || 1, 2);

  let W=0, H=0, flakes=[];
  let running = true;

  function resize(){
    W = Math.floor(window.innerWidth);
    H = Math.floor(window.innerHeight);
    c.width  = Math.floor(W * DPR);
    c.height = Math.floor(H * DPR);
    c.style.width = W + 'px';
    c.style.height = H + 'px';
    ctx.setTransform(DPR,0,0,DPR,0,0);
  }

  function makeFlake(){
    const r = 1 + Math.random()*2.8;
    return {
      x: Math.random()*W,
      y: -10 - Math.random()*H,
      r,
      vy: 0.55 + Math.random()*1.85,
      vx: -0.7 + Math.random()*1.4,
      sway: 0.6 + Math.random()*1.6,
      a: 0.25 + Math.random()*0.55
    };
  }

  function computeCount(){
    const base = Math.round((W*H) / 18000);
    return Math.max(40, Math.min(160, base));
  }

  function reset(){
    flakes = Array.from({length: computeCount()}, makeFlake);
  }

  function draw(){
    if(!running) return;
    ctx.clearRect(0,0,W,H);

    for(const f of flakes){
      f.y += f.vy;
      f.x += f.vx + Math.sin((f.y/40)) * f.sway * 0.15;

      if(f.y > H + 20){ f.y = -20; f.x = Math.random()*W; }
      if(f.x < -20) f.x = W+20;
      if(f.x > W+20) f.x = -20;

      ctx.beginPath();
      ctx.arc(f.x, f.y, f.r, 0, Math.PI*2);
      ctx.fillStyle = `rgba(255,255,255,${f.a})`;
      ctx.fill();
    }
    requestAnimationFrame(draw);
  }

  resize();
  reset();
  draw();

  window.addEventListener('resize', ()=>{
    resize();
    reset();
  });

  mq.addEventListener?.('change', (e)=>{
    running = !e.matches;
    if(running) draw();
    else ctx.clearRect(0,0,W,H);
  });
})();

/* ===== INIT ===== */
renderGameTabs();
setGame(currentGame);
fillFromProfile();
updateSummary();
initHistoryFilters();
renderHistory();
</script>
</body>
</html>
